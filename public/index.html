<!DOCTYPE html>
<html>
  <head>
    <title>Magpollo Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              log: '#ffffff',
              warn: '#ffff00',
              error: '#ff0000',
              info: '#0000ff',
              debug: '#ff00ff',
              success: '#00ff00',
              terminal: {
                bg: '#1a1b26',
                border: '#24283b',
                text: '#a9b1d6',
                highlight: '#7aa2f7',
              },
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-terminal-bg text-terminal-text font-mono">
    <!-- Mobile Menu Button -->
    <button
      id="mobileMenuBtn"
      class="lg:hidden fixed top-4 right-4 z-50 p-2 rounded hover:bg-terminal-border"
    >
      â˜°
    </button>

    <div class="h-screen flex flex-col lg:flex-row">
      <!-- Sidebar -->
      <div
        id="sidebar"
        class="hidden lg:block w-full lg:w-48 border-b lg:border-r lg:border-b-0 border-terminal-border"
      >
        <div class="p-4 border-b border-terminal-border">
          <h1 class="text-xl font-bold">Magpollo</h1>
        </div>
        <nav class="p-4 space-y-2">
          <button
            id="logsBtn"
            class="w-full text-left p-2 rounded hover:bg-terminal-border"
          >
            ðŸ“‹ Logs
          </button>
          <button
            id="chatBtn"
            class="w-full text-left p-2 rounded hover:bg-terminal-border"
          >
            ðŸ’¬ Chat
          </button>
        </nav>
        <div class="p-4 border-t border-terminal-border">
          <select
            id="characterSelect"
            class="w-full bg-terminal-bg text-terminal-text border border-terminal-border rounded p-2"
          >
            <option value="morty">Morty</option>
            <option value="zach">Zach</option>
          </select>
        </div>
      </div>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col">
        <!-- Header -->
        <header
          class="border-b border-terminal-border p-4 flex justify-between items-center"
        >
          <div
            id="currentView"
            class="text-xl"
          >
            Logs
          </div>
          <div
            id="status"
            class="px-3 py-1 rounded-full text-sm"
          ></div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-hidden">
          <!-- Logs View -->
          <div
            id="logsView"
            class="h-full"
          >
            <div
              id="logs"
              class="p-4 h-full overflow-y-auto"
            ></div>
          </div>

          <!-- Chat View -->
          <div
            id="chatView"
            class="h-full hidden flex flex-col"
          >
            <div
              id="messages"
              class="flex-1 p-4 overflow-y-auto space-y-4"
            ></div>
            <div class="border-t border-terminal-border p-4">
              <form
                id="chatForm"
                class="flex gap-2"
              >
                <input
                  type="text"
                  id="messageInput"
                  class="flex-1 bg-terminal-bg border border-terminal-border rounded p-2 text-terminal-text"
                  placeholder="Type your message..."
                />
                <button
                  type="submit"
                  id="sendButton"
                  class="px-4 py-2 bg-terminal-border rounded hover:bg-terminal-highlight/20 min-w-[4rem] flex items-center justify-center"
                >
                  Send
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Mobile menu handling
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.getElementById('sidebar');

      mobileMenuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('hidden');
      });

      // Hide sidebar on mobile when clicking outside
      document.addEventListener('click', (e) => {
        if (
          window.innerWidth < 1024 &&
          !sidebar.contains(e.target) &&
          !mobileMenuBtn.contains(e.target)
        ) {
          sidebar.classList.add('hidden');
        }
      });

      // Existing WebSocket setup
      const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsHost =
        window.location.hostname === 'localhost'
          ? 'localhost:3001'
          : window.location.host;
      const ws = new WebSocket(`${wsProtocol}//${wsHost}`);

      const LOG_ICONS = {
        LOG: 'â—Ž',
        WARN: 'âš ',
        ERROR: 'â›”',
        INFO: 'â„¹',
        DEBUG: 'â°§',
        SUCCESS: 'âœ“',
      };

      const LOG_COLORS = {
        LOG: 'text-log',
        WARN: 'text-warn',
        ERROR: 'text-error',
        INFO: 'text-info',
        DEBUG: 'text-debug',
        SUCCESS: 'text-success',
      };

      // UI Elements
      const logsBtn = document.getElementById('logsBtn');
      const chatBtn = document.getElementById('chatBtn');
      const logsView = document.getElementById('logsView');
      const chatView = document.getElementById('chatView');
      const currentView = document.getElementById('currentView');
      const characterSelect = document.getElementById('characterSelect');
      const chatForm = document.getElementById('chatForm');
      const messageInput = document.getElementById('messageInput');
      const messages = document.getElementById('messages');
      const sendButton = document.getElementById('sendButton');

      // View switching
      logsBtn.addEventListener('click', () => {
        logsView.classList.remove('hidden');
        chatView.classList.add('hidden');
        currentView.textContent = 'Logs';
        if (window.innerWidth < 1024) sidebar.classList.add('hidden');
      });

      chatBtn.addEventListener('click', () => {
        logsView.classList.add('hidden');
        chatView.classList.remove('hidden');
        currentView.textContent = 'Chat';
        if (window.innerWidth < 1024) sidebar.classList.add('hidden');
      });

      // Chat functionality
      chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;

        const character = characterSelect.value;

        // Clear input and disable form immediately
        messageInput.value = '';
        messageInput.disabled = true;
        sendButton.disabled = true;
        sendButton.textContent = '...';

        // Add user message to chat
        addChatMessage('You', message);

        try {
          const response = await fetch(
            `http://localhost:3000/${character}/message`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                text: message,
                userId: 'user',
                userName: 'User',
              }),
            }
          );

          const data = await response.json();
          data.forEach((msg) => addChatMessage(character, msg.text));
        } catch (error) {
          console.error('Error:', error);
          addChatMessage('System', 'Error sending message');
        } finally {
          // Re-enable form
          messageInput.disabled = false;
          sendButton.disabled = false;
          sendButton.textContent = 'Send';
          messageInput.focus();
        }
      });

      function addChatMessage(sender, text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex gap-2 items-start';
        messageDiv.innerHTML = `
          <span class="text-terminal-highlight whitespace-nowrap">${sender}:</span>
          <span class="break-words">${text}</span>
        `;
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
      }

      // Existing log functionality
      function updateStatus(connected) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = connected ? 'Connected' : 'Disconnected';
        statusDiv.className = connected
          ? 'px-3 py-1 rounded-full text-sm bg-green-900 text-green-300'
          : 'px-3 py-1 rounded-full text-sm bg-red-900 text-red-300';
      }

      function addLogEntry(log) {
        const entry = document.createElement('div');
        entry.className = 'py-1 flex gap-2 items-start';
        entry.innerHTML = `
          <span class="text-gray-500">[${log.timestamp}]</span>
          <span class="${LOG_COLORS[log.level] || 'text-white'}">${
          LOG_ICONS[log.level] || ''
        } ${log.level}:</span>
          <span class="text-terminal-text whitespace-pre-wrap">${
            log.message
          }</span>
        `;

        const logsDiv = document.getElementById('logs');
        logsDiv.appendChild(entry);
        logsDiv.scrollTop = logsDiv.scrollHeight;

        while (logsDiv.children.length > 1000) {
          logsDiv.removeChild(logsDiv.firstChild);
        }
      }

      ws.onopen = () => updateStatus(true);
      ws.onclose = () => updateStatus(false);
      ws.onmessage = (event) => addLogEntry(JSON.parse(event.data));
    </script>
  </body>
</html>
